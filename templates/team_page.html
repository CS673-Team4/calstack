<!DOCTYPE html>
<html>
<head>
    <title>{{ team.name }} - Team Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .profile-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #888;
        }
        .avatar-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #bbb;
            cursor: pointer;
        }
        .avatar.selected {
            border: 3px solid #007bff;
        }
        .calendar-cell {
            width: 36px;
            height: 36px;
            display: inline-block;
            margin: 2px;
            border-radius: 6px;
            background: #e0e0e0;
            text-align: center;
            line-height: 36px;
        }
        .calendar-cell.busy {
            background: #ff6961;
            color: #fff;
        }
    </style>
</head>
<body class="bg-light">
<div class="container-fluid py-4">
    <div class="row">
        <!-- Left Panel -->
        <div class="col-md-4 bg-white rounded shadow-sm p-4 mb-3">
            <div class="d-flex flex-column align-items-center">
                <img src="https://ui-avatars.com/api/?name={{ selected_member or user_email }}" class="profile-img mb-2" id="profile-img">
                <h5 id="profile-name">{{ selected_member or user_email }}</h5>
            </div>
            <hr>
            <h6 class="text-center">Availability (next 7 days)</h6>
            <div class="mb-2">
                <span class="badge bg-danger">Busy</span>
                <span class="badge bg-light border ms-2">Free</span>
            </div>
            <div id="calendar-view" class="table-responsive">
                <!-- Calendar table will be rendered here by JS -->
            </div>
        </div>
        <!-- Right Panel -->
        <div class="col-md-8">
            <div class="d-flex flex-column h-100">
                <div class="d-flex align-items-center mb-3">
                    <h3 class="me-auto">{{ team.name }}</h3>
                    <span class="badge bg-secondary">Invite Code: {{ team.code }}</span>
                </div>
                <div class="avatar-row mb-4">
                    {% for member in members %}
                        <img src="https://ui-avatars.com/api/?name={{ member }}" class="avatar{% if member == user_email %} selected{% endif %}" data-email="{{ member }}" title="{{ member }}">
                    {% endfor %}
                </div>
                <button class="btn btn-primary mb-3" id="schedule-meeting-btn">Schedule Meeting</button>
<!-- Schedule Meeting Modal (Multi-step) -->
<div class="modal fade" id="scheduleMeetingModal" tabindex="-1" aria-labelledby="scheduleMeetingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scheduleMeetingModalLabel">Schedule Meeting</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Step 1: Participant & Filter Selection -->
        <div id="schedule-step-1">
          <h6>Select Participants</h6>
          <div id="participant-checkboxes" class="mb-3"></div>
          <h6>Filter</h6>
          <div class="mb-2">
            <label>Days of Week:</label><br>
            <div id="days-checkboxes" class="mb-2"></div>
          </div>
          <div class="mb-2">
            <label>Duration:</label>
            <select id="meeting-duration" class="form-select w-auto d-inline-block ms-2">
              <option value="30">30 min</option>
              <option value="60" selected>1 hour</option>
              <option value="90">1.5 hours</option>
              <option value="120">2 hours</option>
            </select>
          </div>
          <div class="mb-2">
            <label for="hours-range">Hours Considered:</label>
            <input type="range" class="form-range" min="6" max="22" step="1" id="hours-range" value="18">
            <span id="hours-range-label">6:00 - 18:00</span>
          </div>
          <button class="btn btn-primary mt-2" id="meeting-next-btn">Next</button>
        </div>
        <!-- Step 2: Suggested Times Selection -->
        <div id="schedule-step-2" style="display:none;">
          <h6>Recommended Meeting Times</h6>
          <form id="suggested-times-form">
            <div id="suggested-times-list" class="mb-3"></div>
            <button class="btn btn-primary" id="create-voting-btn" type="submit">Create Voting</button>
          </form>
          <button class="btn btn-secondary mt-2" id="meeting-back-btn">Back</button>
        </div>
        <!-- Step 3: Voting UI placeholder -->
        <div id="schedule-step-3" style="display:none;">
          <h6>Voting Created!</h6>
          <div class="alert alert-info">Voting has been created and will appear in the Upcoming Voting section.</div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
// Populate participant checkboxes
function renderParticipants(members, user_email) {
  let html = '';
  members.forEach(m => {
    html += `<label class='me-2'><input type='checkbox' name='participants' value='${m}' checked> ${m === user_email ? m + ' (You)' : m}</label>`;
  });
  $('#participant-checkboxes').html(html);
}
// Populate days of week checkboxes
function renderDaysCheckboxes() {
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let html = '';
  days.forEach((d,i) => {
    html += `<label class='me-2'><input type='checkbox' name='days' value='${i}' checked> ${d}</label>`;
  });
  $('#days-checkboxes').html(html);
}
// Hours slider label update
$('#hours-range').on('input', function() {
  $('#hours-range-label').text('6:00 - ' + this.value + ':00');
});
// Modal step logic
let members = {{ members|tojson }};
let user_email = {{ user_email|tojson }};
$('#schedule-meeting-btn').click(function() {
  renderParticipants(members, user_email);
  renderDaysCheckboxes();
  $('#hours-range').val(18); $('#hours-range-label').text('6:00 - 18:00');
  $('#schedule-step-1').show();
  $('#schedule-step-2').hide();
  $('#schedule-step-3').hide();
  const modal = new bootstrap.Modal(document.getElementById('scheduleMeetingModal'));
  modal.show();
});
$('#meeting-next-btn').click(function() {
  // Gather filters
  let participants = [];
  $('input[name="participants"]:checked').each(function(){participants.push($(this).val());});
  let days = [];
  $('input[name="days"]:checked').each(function(){days.push(parseInt($(this).val()));});
  let duration = parseInt($('#meeting-duration').val());
  let hours = parseInt($('#hours-range').val());
  // Fetch suggested times
  $('#suggested-times-list').html('<div class="text-center text-muted">Loading...</div>');
  $('#schedule-step-1').hide();
  $('#schedule-step-2').show();
  $.ajax({
    url: '{{ url_for("suggest_slots", team_id=team._id) }}',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({participants, days, duration, end_hour: hours}),
    success: function(data) {
      if(data.suggested_slots && data.suggested_slots.length > 0) {
        let html = '';
        data.suggested_slots.forEach((slot,i) => {
          const start = luxon.DateTime.fromISO(slot.start).toLocal();
          const end = luxon.DateTime.fromISO(slot.end).toLocal();
          html += `<div><label><input type='checkbox' name='slot' value='${slot.start}|${slot.end}' checked> ${start.toFormat('cccc, LLL dd, t')} – ${end.toFormat('t')}</label></div>`;
        });
        $('#suggested-times-list').html(html);
      } else {
        $('#suggested-times-list').html('<div class="alert alert-warning">No mutually available times found.</div>');
      }
    },
    error: function() {
      $('#suggested-times-list').html('<div class="alert alert-danger">Failed to load suggestions.</div>');
    }
  });
});
$('#meeting-back-btn').click(function() {
  $('#schedule-step-2').hide();
  $('#schedule-step-1').show();
});
$('#suggested-times-form').submit(function(e) {
  e.preventDefault();
  // Gather selected slots
  let slots = [];
  $('input[name="slot"]:checked').each(function(){
    let [start, end] = $(this).val().split('|');
    slots.push({start, end});
  });
  if(slots.length === 0) {
    alert('Please select at least one time slot.');
    return;
  }
  // Create poll
  $.ajax({
    url: '{{ url_for("create_poll", team_id=team._id) }}',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({slots}),
    success: function(data) {
      $('#schedule-step-2').hide();
      $('#schedule-step-3').show();
    },
    error: function() {
      alert('Failed to create voting.');
    }
  });
});
</script>
                <div class="row">
                    <div class="col-md-6">
                        <div class="p-3 bg-white rounded shadow-sm mb-3">
                            <h5>Upcoming Meetings</h5>
                            <div class="text-muted">(Coming soon)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-white rounded shadow-sm mb-3">
                            <h5>Upcoming Voting</h5>
                            <div class="text-muted">(Coming soon)</div>
                        </div>
                    </div>
                </div>
                <a href="{{ url_for('home') }}" class="mt-auto">Back to Home</a>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Helper: get busy blocks for 7 days, render as table
function renderCalendar(busy) {
    // Use luxon for timezone-safe conversion
    const { DateTime, Interval } = luxon;
    const tz = 'America/New_York';
    // Start from today in Eastern Time
    const start = DateTime.now().setZone(tz).startOf('day');
    const days = [];
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    for (let i = 0; i < 7; i++) {
        days.push(start.plus({ days: i }));
    }
    // Convert busy blocks to Eastern Time intervals
    const busyIntervals = busy.map(b => Interval.fromDateTimes(
        DateTime.fromISO(b.start, { zone: 'utc' }).setZone(tz),
        DateTime.fromISO(b.end, { zone: 'utc' }).setZone(tz)
    ));
    // Build table
    let html = '<table class="table table-bordered text-center align-middle mb-0"><thead><tr><th style="width:70px">Hour</th>';
    days.forEach(day => {
        html += `<th><div>${dayNames[day.weekday % 7]}</div><div class='small text-muted'>${day.toISODate()}</div></th>`;
    });
    html += '</tr></thead><tbody>';
    // 8am-8pm, 1hr blocks
    for (let h = 8; h <= 20; h++) {
        html += `<tr><th scope="row">${h}:00</th>`;
        days.forEach(day => {
            // Cell interval in ET
            const blockStart = day.set({ hour: h, minute: 0, second: 0, millisecond: 0 });
            const blockEnd = blockStart.plus({ hours: 1 });
            // Is this block busy?
            let isBusy = busyIntervals.some(intv => intv.overlaps(Interval.fromDateTimes(blockStart, blockEnd)));
            html += `<td class="${isBusy ? 'bg-danger text-white' : ''}">${isBusy ? '<span title="Busy">●</span>' : ''}</td>`;
        });
        html += '</tr>';
    }
    html += '</tbody></table>';
    $('#calendar-view').html(html);
}
    // Initial render
    renderCalendar({{ busy|tojson }});

    // Schedule Meeting button handler
    $('#schedule-meeting-btn').click(function() {
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('scheduleMeetingModal'));
        $('#suggested-slots-list').html('<div class="text-center text-muted">Loading suggestions...</div>');
        modal.show();
        // Fetch suggested slots
        $.getJSON('{{ url_for("suggest_slots", team_id=team._id) }}', function(data) {
            if (data.suggested_slots && data.suggested_slots.length > 0) {
                let html = '<ul class="list-group">';
                data.suggested_slots.forEach(slot => {
                    // Show as local time
                    const start = luxon.DateTime.fromISO(slot.start).toLocal();
                    const end = luxon.DateTime.fromISO(slot.end).toLocal();
                    html += `<li class="list-group-item">${start.toFormat('cccc, LLL dd, t')} – ${end.toFormat('t')}</li>`;
                });
                html += '</ul>';
                $('#suggested-slots-list').html(html);
            } else {
                $('#suggested-slots-list').html('<div class="alert alert-warning">No mutually available times found for your team in the next 7 days.</div>');
            }
        }).fail(function() {
            $('#suggested-slots-list').html('<div class="alert alert-danger">Failed to load suggestions.</div>');
        });
    });

    // Member avatar click handler
    $('.avatar').click(function() {
        var email = $(this).data('email');
        $('.avatar').removeClass('selected');
        $(this).addClass('selected');
        // Update profile
        $('#profile-img').attr('src', 'https://ui-avatars.com/api/?name=' + email);
        $('#profile-name').text(email);
        // Fetch calendar
        $.getJSON('{{ url_for("get_member_availability", team_id=team._id, email="__EMAIL__") }}'.replace('__EMAIL__', email), function(data) {
            renderCalendar(data.busy);
        });
    });
</script>
</body>
</html>
