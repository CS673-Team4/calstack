<!doctype html>
<html>
    <head>
        <title>{{ team.name }} - CalStack</title>
        <link
            rel="icon"
            type="image/png"
            href="https://ui-avatars.com/api/?name=Team+Icon"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- jQuery CDN (required for $) -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <style>
            :root {
                --black: #000000;
                --white: #ffffff;
                --gray-50: #fafafa;
                --gray-100: #f5f5f5;
                --gray-200: #e5e5e5;
                --gray-300: #d1d5db;
                --gray-400: #a3a3a3;
                --gray-600: #525252;
                --gray-700: #374151;
                --gray-900: #171717;
                --green-50: #f0fdf4;
                --green-100: #dcfce7;
                --green-500: #22c55e;
                --red-50: #fef2f2;
                --red-100: #fee2e2;
                --red-500: #ef4444;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    sans-serif;
                line-height: 1.6;
                color: var(--black);
                background: var(--gray-50);
                font-feature-settings: "cv01", "cv03", "cv04", "cv11";
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            .brand {
                font-family: "Inter", sans-serif;
                font-weight: 600;
                letter-spacing: -0.02em;
            }

            /* Header */
            .team-header {
                background: var(--white);
                border-bottom: 1px solid var(--gray-200);
                padding: 1.5rem 0;
                margin-bottom: 2rem;
            }

            .team-title {
                font-size: 1.75rem;
                font-weight: 600;
                color: var(--black);
                letter-spacing: -0.02em;
            }

            .team-code {
                background: var(--gray-100);
                color: var(--gray-600);
                padding: 0.375rem 0.75rem;
                border-radius: 6px;
                font-size: 0.75rem;
                font-weight: 500;
                font-family: "SF Mono", "Monaco", monospace;
            }

            /* Member avatars */
            .member-section {
                margin-bottom: 2rem;
            }

            .section-label {
                font-size: 0.875rem;
                font-weight: 500;
                color: var(--gray-600);
                margin-bottom: 1rem;
            }

            .avatar-row {
                display: flex;
                gap: 0.75rem;
                flex-wrap: wrap;
            }

            .avatar {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                border: 2px solid var(--gray-200);
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .avatar:hover {
                border-color: var(--gray-400);
                transform: scale(1.05);
            }

            .avatar.selected {
                border-color: var(--black);
                border-width: 3px;
            }

            /* Actions */
            .actions-section {
                margin-bottom: 2rem;
            }

            .actions-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }

            .btn {
                padding: 0.75rem 1.5rem;
                border-radius: 8px;
                font-weight: 500;
                font-size: 0.875rem;
                text-decoration: none;
                border: none;
                cursor: pointer;
                transition: all 0.2s ease;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }

            .btn-primary {
                background: var(--black);
                color: var(--white);
                border: 1px solid var(--black);
            }

            .btn-primary:hover {
                background: var(--gray-900);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .btn-secondary {
                background: var(--gray-100);
                color: var(--gray-700);
                border: 1px solid var(--gray-200);
            }

            .btn-secondary:hover {
                background: var(--gray-200);
                border-color: var(--gray-300);
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .btn-outline-danger {
                background: transparent;
                color: #dc2626;
                border: 1px solid #dc2626;
            }

            .btn-outline-danger:hover {
                background: #dc2626;
                color: var(--white);
            }

            /* Calendar */
            .calendar-section {
                background: var(--white);
                border-radius: 12px;
                padding: 2rem;
                box-shadow: 0 2px 16px rgba(0, 0, 0, 0.04);
                border: 1px solid var(--gray-200);
                margin-bottom: 2rem;
            }

            .calendar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
            }

            .profile-info {
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .profile-img {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                border: 2px solid var(--gray-200);
            }

            .profile-name {
                font-size: 1.125rem;
                font-weight: 600;
                color: var(--black);
            }

            .calendar-legend {
                display: flex;
                gap: 1rem;
                align-items: center;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.75rem;
                color: var(--gray-600);
            }

            .legend-color {
                width: 12px;
                height: 12px;
                border-radius: 3px;
            }

            .legend-busy {
                background: var(--red-500);
            }
            .legend-free {
                background: var(--green-500);
            }

            /* Calendar Grid */
            .calendar-grid {
                display: grid;
                grid-template-columns: 60px repeat(7, 1fr);
                gap: 1px;
                background: var(--gray-200);
                border-radius: 8px;
                overflow: hidden;
            }

            .calendar-cell {
                background: var(--white);
                padding: 0.75rem 0.5rem;
                text-align: center;
                font-size: 0.75rem;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
            }

            .calendar-header-cell {
                background: var(--gray-100);
                font-weight: 600;
                color: var(--gray-700);
            }

            .calendar-time-cell {
                background: var(--gray-50);
                font-weight: 500;
                color: var(--gray-600);
                font-size: 0.625rem;
            }

            .calendar-day-header {
                background: var(--gray-100);
                font-weight: 600;
                color: var(--gray-700);
                flex-direction: column;
                gap: 0.25rem;
            }

            .day-name {
                font-size: 0.625rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .day-date {
                font-size: 0.75rem;
            }

            .calendar-slot {
                background: var(--white);
                border: 1px solid var(--gray-200);
                transition: all 0.2s ease;
            }

            .calendar-slot:hover {
                background: var(--gray-50);
            }

            .calendar-slot.busy {
                background: var(--red-500);
                color: var(--white);
                border-color: var(--red-500);
            }

            .calendar-slot.busy:hover {
                background: #dc2626;
            }

            /* Content sections */
            .content-section {
                background: var(--white);
                border-radius: 12px;
                padding: 1.5rem;
                box-shadow: 0 2px 16px rgba(0, 0, 0, 0.04);
                border: 1px solid var(--gray-200);
                margin-bottom: 1.5rem;
            }

            .section-title {
                font-size: 1.125rem;
                font-weight: 600;
                color: var(--black);
                margin-bottom: 1rem;
                letter-spacing: -0.01em;
            }

            .empty-state {
                text-align: center;
                padding: 2rem;
                color: var(--gray-600);
                font-size: 0.875rem;
            }

            .back-link {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                color: var(--gray-600);
                text-decoration: none;
                font-size: 0.875rem;
                margin-top: 2rem;
            }

            .back-link:hover {
                color: var(--black);
            }

            .logout-btn {
                background: var(--white);
                border: 1px solid var(--gray-300);
                color: var(--gray-700);
                padding: 0.5rem 1rem;
                border-radius: 8px;
                text-decoration: none;
                font-size: 0.875rem;
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .logout-btn:hover {
                background: var(--gray-50);
                color: var(--gray-900);
                border-color: var(--gray-400);
                text-decoration: none;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            }

            /* Responsive */
            @media (max-width: 768px) {
                .team-header .d-flex {
                    flex-direction: column;
                    gap: 1rem;
                    text-align: center;
                }

                .actions-grid {
                    grid-template-columns: 1fr;
                }

                .calendar-grid {
                    grid-template-columns: 50px repeat(7, 1fr);
                }

                .calendar-cell {
                    padding: 0.5rem 0.25rem;
                    font-size: 0.625rem;
                    min-height: 36px;
                }

                .profile-info {
                    flex-direction: column;
                    text-align: center;
                }

                .calendar-legend {
                    justify-content: center;
                }
            }
        </style>
    </head>
    <body>
        <div class="container-fluid py-4">
            <!-- Header -->
            <div class="team-header">
                <div class="container">
                    <div
                        class="d-flex justify-content-between align-items-center"
                    >
                        <h1 class="team-title">{{ team.name }}</h1>
                        <div class="d-flex align-items-center gap-3">
                            <span class="team-code">{{ team.code }}</span>
                            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container">
                <!-- Team Members -->
                <div class="member-section">
                    <div class="section-label">Team Members</div>
                    <div class="avatar-row">
                        {% for member in members %}
                        <img
                            src="https://ui-avatars.com/api/?name={{ member }}"
                            class="avatar{% if member == user_email %} selected{% endif %}"
                            data-email="{{ member }}"
                            title="{{ member }}"
                        />
                        {% endfor %}
                        <button id="team-overlay-btn" class="btn btn-outline-secondary btn-sm" style="margin-left: 1rem;">
                            Team Overlay
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="actions-section">
                    <div class="actions-grid">
                        <button
                            class="btn btn-primary"
                            id="schedule-meeting-btn"
                        >
                            📅 Schedule Meeting
                        </button>
                        <button
                            class="btn btn-secondary"
                            id="invite-members-btn"
                        >
                            👥 Invite Members
                        </button>
                        <button
                            class="btn btn-outline-danger"
                            id="leave-team-btn"
                        >
                            🚪 Leave Team
                        </button>
                    </div>
                </div>

                <!-- Calendar -->
                <div class="calendar-section">
                    <div class="calendar-header">
                        <div class="profile-info">
                            <img
                                src="https://ui-avatars.com/api/?name={{ user_email }}"
                                class="profile-img"
                                id="profile-img"
                            />
                            <div>
                                <div class="profile-name" id="profile-name">
                                    {{ user_email }}
                                </div>
                                <div class="section-label">
                                    Availability (next 7 days)
                                </div>
                            </div>
                        </div>
                        <div class="calendar-legend">
                            <div class="legend-item">
                                <div
                                    class="legend-color"
                                    style="
                                        background: var(--white);
                                        border: 1px solid var(--gray-200);
                                    "
                                ></div>
                                <span>Free</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-busy"></div>
                                <span>Busy</span>
                            </div>
                        </div>
                    </div>
                    <div id="calendar-view">
                        <!-- Calendar will be rendered here by JS -->
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="content-section">
                            <h3 class="section-title">Upcoming Meetings</h3>
                            <div id="meetings-list">
                                <div class="empty-state">Loading...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="content-section">
                            <h3 class="section-title">Open Polls</h3>
                            <div id="polls-list">
                                <div class="empty-state">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <a href="{{ url_for('home') }}" class="back-link">
                    ← Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Modals -->
        <!-- Invite Members Modal -->
        <div
            class="modal fade"
            id="inviteMembersModal"
            tabindex="-1"
            aria-labelledby="inviteMembersModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="inviteMembersModalLabel">
                            Invite Members
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label"
                                >Share this invite code:</label
                            >
                            <div class="input-group mb-2">
                                <input
                                    type="text"
                                    class="form-control"
                                    value="{{ team.code }}"
                                    id="invite-code-input"
                                    readonly
                                />
                                <button
                                    class="btn btn-outline-secondary"
                                    type="button"
                                    id="copy-invite-code-btn"
                                >
                                    Copy
                                </button>
                            </div>
                        </div>
                        <hr />
                        <form id="invite-members-form">
                            <label for="invite-emails" class="form-label"
                                >Or enter email addresses to send invites
                                (comma-separated):</label
                            >
                            <input
                                type="text"
                                class="form-control mb-2"
                                id="invite-emails"
                                placeholder="email1@example.com, email2@example.com"
                            />
                            <button type="submit" class="btn btn-primary">
                                Send Invites
                            </button>
                            <div id="invite-members-status" class="mt-2"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Meeting Modal -->
        <div
            class="modal fade"
            id="scheduleMeetingModal"
            tabindex="-1"
            aria-labelledby="scheduleMeetingModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="scheduleMeetingModalLabel">
                            Schedule Meeting
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <!-- Step 1: Configuration -->
                        <div id="schedule-step-1">
                            <h6>Select Participants</h6>
                            <div id="participant-checkboxes" class="mb-3"></div>

                            <h6>Meeting Settings</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label" for="meeting-duration">Duration:</label>
                                    <select
                                        id="meeting-duration"
                                        class="form-select"
                                    >
                                        <option value="30">30 minutes</option>
                                        <option value="60" selected>
                                            1 hour
                                        </option>
                                        <option value="90">1.5 hours</option>
                                        <option value="120">2 hours</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="algorithm-select">Algorithm:</label>
                                    <select
                                        id="algorithm-select"
                                        class="form-select"
                                    >
                                        <option value="next" selected>
                                            Next Available
                                        </option>
                                        <option value="split">
                                            Split Days
                                        </option>
                                        <option value="random">Random</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label"
                                        >Number of Slots:</label
                                    >
                                    <input
                                        type="number"
                                        id="num-slots"
                                        class="form-control"
                                        value="5"
                                        min="1"
                                        max="20"
                                    />
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <div class="form-check">
                                        <input
                                            class="form-check-input"
                                            type="checkbox"
                                            id="avoid-work-hours"
                                        />
                                        <label
                                            class="form-check-label"
                                            for="avoid-work-hours"
                                            >Avoid Work Hours</label
                                        >
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="form-label">Days of Week:</label>
                                <div
                                    id="days-checkboxes"
                                    class="d-flex gap-2 flex-wrap"
                                ></div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="hours-from">From:</label>
                                    <input
                                        type="time"
                                        id="hours-from"
                                        value="08:00"
                                        class="form-control"
                                    />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="hours-to">To:</label>
                                    <input
                                        type="time"
                                        id="hours-to"
                                        value="20:00"
                                        class="form-control"
                                    />
                                </div>
                            </div>

                            <div
                                id="schedule-error"
                                class="text-danger mt-2"
                                style="display: none"
                            ></div>
                            <button
                                class="btn btn-primary mt-3"
                                id="meeting-next-btn"
                            >
                                Find Times
                            </button>
                        </div>

                        <!-- Step 2: Time Selection -->
                        <div id="schedule-step-2" style="display: none">
                            <h6>Available Meeting Times</h6>
                            <form id="suggested-times-form">
                                <div
                                    id="suggested-times-list"
                                    class="mb-3"
                                ></div>
                                <button class="btn btn-primary" type="submit">
                                    Create Poll
                                </button>
                            </form>
                            <button
                                class="btn btn-secondary mt-2"
                                id="meeting-back-btn"
                            >
                                Back
                            </button>
                        </div>

                        <!-- Step 3: Success -->
                        <div id="schedule-step-3" style="display: none">
                            <div class="text-center">
                                <h5>✅ Poll Created!</h5>
                                <p class="text-muted">
                                    Your scheduling poll has been created and
                                    will appear in the Open Polls section.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Variables - Get from DOM to avoid Jinja template issues
            var members = [];
            var user_email = "{{ user_email }}";
            var team = {_id: "{{ team._id }}"};
            var user_timezone = "{{ user_timezone or 'UTC' }}";
            
            // Extract members from DOM
            document.querySelectorAll('.avatar').forEach(function(el) {
                var email = el.getAttribute('data-email');
                if (email) members.push(email);
            });
            
            console.log('Initialized variables:', {members, user_email, team, user_timezone});

            // Modern Calendar Renderer
            function renderCalendar(busy) {
                const { DateTime, Interval } = luxon;
                const tz = user_timezone || 'UTC';
                const start = DateTime.now().setZone(tz).startOf('day');

                // Generate 7 days
                const days = [];
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                for (let i = 0; i < 7; i++) {
                    days.push(start.plus({ days: i }));
                }

                // Convert busy times to intervals
                const busyIntervals = busy.map(b => Interval.fromDateTimes(
                    DateTime.fromISO(b.start, { zone: 'utc' }).setZone(tz),
                    DateTime.fromISO(b.end, { zone: 'utc' }).setZone(tz)
                ));

                // Build modern calendar grid
                let html = '<div class="calendar-grid">';

                // Header row
                html += '<div class="calendar-cell calendar-header-cell">Time</div>';
                days.forEach(day => {
                    html += `<div class="calendar-cell calendar-day-header">
                        <div class="day-name">${dayNames[day.weekday % 7]}</div>
                        <div class="day-date">${day.toFormat('M/d')}</div>
                    </div>`;
                });

                // Time rows (8 AM to 8 PM in 1-hour blocks)
                for (let h = 8; h <= 20; h++) {
                    html += `<div class="calendar-cell calendar-time-cell">${h}:00</div>`;

                    days.forEach(day => {
                        const blockStart = day.set({ hour: h, minute: 0, second: 0, millisecond: 0 });
                        const blockEnd = blockStart.plus({ hours: 1 });

                        // Check if this block overlaps with any busy time
                        const isBusy = busyIntervals.some(intv =>
                            intv.overlaps(Interval.fromDateTimes(blockStart, blockEnd))
                        );

                        html += `<div class="calendar-cell calendar-slot${isBusy ? ' busy' : ''}"
                                 title="${blockStart.toFormat('cccc t')} - ${blockEnd.toFormat('t')} (${isBusy ? 'Busy' : 'Free'})">
                                 ${isBusy ? '●' : ''}
                             </div>`;
                    });
                }

                html += '</div>';
                $('#calendar-view').html(html);
            }

            // Initialize calendar with current user's data
            renderCalendar({{ busy|tojson }});

            // Rest of your existing JavaScript for modals, meetings, polls, etc.
            // (I'll include the essential parts to keep functionality working)

            // Modal setup functions
            function renderParticipants(members, user_email) {
                let html = '';
                members.forEach(m => {
                    html += `<label class='me-2'><input type='checkbox' name='participants' value='${m}' checked> ${m === user_email ? m + ' (You)' : m}</label>`;
                });
                $('#participant-checkboxes').html(html);
            }

            function renderDaysCheckboxes() {
                const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                let html = '';
                days.forEach((d,i) => {
                    html += `<label class='me-2'><input type='checkbox' name='days' value='${i}' checked> ${d}</label>`;
                });
                $('#days-checkboxes').html(html);
            }

            // Avatar click handler
            $('.avatar').click(function() {
                var email = $(this).data('email');
                $('.avatar').removeClass('selected');
                $(this).addClass('selected');

                // Update Team Overlay button to show it's not active
                $('#team-overlay-btn').removeClass('btn-primary').addClass('btn-outline-secondary').text('Team Overlay');

                $('#profile-img').attr('src', 'https://ui-avatars.com/api/?name=' + email);
                $('#profile-name').text(email);

                // Fetch and render calendar for selected member
                $.getJSON(`/team/${team._id}/availability/${email}`, function(data) {
                    renderCalendar(data.busy);
                });
            });

            // Team Overlay button handler
            $('#team-overlay-btn').click(function() {
                // Clear individual avatar selection
                $('.avatar').removeClass('selected');
                
                // Update button to show it's active
                $(this).removeClass('btn-outline-secondary').addClass('btn-primary').text('Team Overlay (Active)');
                
                // Update profile to show team overlay
                $('#profile-img').attr('src', 'https://ui-avatars.com/api/?name=Team+Overlay');
                $('#profile-name').text('Team Overlay - All Members');
                
                // Fetch and render overlay calendar
                $.getJSON(`/team/${team._id}/availability/overlay`, function(data) {
                    renderCalendar(data.busy);
                });
            });

            // Button handlers
            $('#schedule-meeting-btn').click(function() {
                populateParticipants();
                populateDaysOfWeek();
                $('#schedule-step-1').show();
                $('#schedule-step-2').hide();
                $('#schedule-step-3').hide();
                const modal = new bootstrap.Modal(document.getElementById('scheduleMeetingModal'));
                modal.show();
            });

            $('#invite-members-btn').click(function() {
                const modal = new bootstrap.Modal(document.getElementById('inviteMembersModal'));
                modal.show();
            });

            $('#leave-team-btn').click(function() {
                if (confirm('Are you sure you want to leave this team?')) {
                    fetch(`/api/team/${team._id}/leave`, {method: 'POST'})
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                window.location.href = '/home';
                            } else {
                                alert(data.error || 'Failed to leave team.');
                            }
                        });
                }
            });

            // Schedule Meeting functionality
            function populateParticipants() {
                const container = $('#participant-checkboxes');
                container.empty();
                members.forEach(member => {
                    const isCurrentUser = member === user_email;
                    const checked = 'checked'; // All members initially selected
                    const disabled = isCurrentUser ? 'disabled' : '';
                    container.append(`
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${member}" id="participant-${member}" ${checked} ${disabled}>
                            <label class="form-check-label" for="participant-${member}">
                                ${member} ${isCurrentUser ? '(You)' : ''}
                            </label>
                        </div>
                    `);
                });
            }

            function populateDaysOfWeek() {
                const container = $('#days-checkboxes');
                container.empty();
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                days.forEach((day, index) => {
                    const checked = index >= 1 && index <= 5 ? 'checked' : ''; // Default to weekdays
                    container.append(`
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${index}" id="day-${index}" ${checked}>
                            <label class="form-check-label" for="day-${index}">${day}</label>
                        </div>
                    `);
                });
            }

            // Find Times button handler
            $('#meeting-next-btn').click(function() {
                const participants = [];
                $('#participant-checkboxes input:checked').each(function() {
                    participants.push($(this).val());
                });

                const selectedDays = [];
                $('#days-checkboxes input:checked').each(function() {
                    selectedDays.push(parseInt($(this).val()));
                });

                if (participants.length < 2) {
                    $('#schedule-error').text('Please select at least 2 participants.').show();
                    return;
                }

                if (selectedDays.length === 0) {
                    $('#schedule-error').text('Please select at least one day of the week.').show();
                    return;
                }

                $('#schedule-error').hide();

                const requestData = {
                    participants: participants,
                    duration: parseInt($('#meeting-duration').val()),
                    algorithm: $('#algorithm-select').val(),
                    num_slots: parseInt($('#num-slots').val()),
                    avoid_work_hours: $('#avoid-work-hours').is(':checked'),
                    days_of_week: selectedDays,
                    hours_from: $('#hours-from').val(),
                    hours_to: $('#hours-to').val()
                };

                // Show loading state
                $(this).prop('disabled', true).text('Finding Times...');

                $.ajax({
                    url: `/team/${team._id}/suggest_slots`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function(data) {
                        console.log('AJAX Response:', data); // Debug log
                        if (data.success) {
                            console.log('Slots received:', data.slots); // Debug log
                            displaySuggestedTimes(data.slots);
                            $('#schedule-step-1').hide();
                            $('#schedule-step-2').show();
                        } else {
                            $('#schedule-error').text(data.error || 'Failed to find available times.').show();
                        }
                    },
                    error: function() {
                        $('#schedule-error').text('Error communicating with server.').show();
                    },
                    complete: function() {
                        $('#meeting-next-btn').prop('disabled', false).text('Find Times');
                    }
                });
            });

            function displaySuggestedTimes(slots) {
                const container = $('#suggested-times-list');
                container.empty();

                if (slots.length === 0) {
                    container.html('<div class="alert alert-warning">No available times found. Try adjusting your criteria.</div>');
                    return;
                }

                // Store slots globally for poll creation
                window.currentSuggestedSlots = slots;
                console.log('Received slots:', slots); // Debug log

                slots.forEach((slot, index) => {
                    console.log('Processing slot:', slot); // Debug log
                    console.log('Slot start string:', slot.start, 'type:', typeof slot.start);
                    console.log('Slot end string:', slot.end, 'type:', typeof slot.end);
                    
                    // Parse dates with robust error handling
                    let startTime, endTime;
                    try {
                        // Ensure we have valid date strings
                        if (!slot.start || !slot.end) {
                            throw new Error('Missing date strings');
                        }
                        
                        // Parse ISO date strings - handle both with and without 'Z'
                        let startStr = slot.start;
                        let endStr = slot.end;
                        
                        // Ensure ISO format compatibility
                        if (!startStr.includes('T')) {
                            throw new Error('Invalid ISO format');
                        }
                        
                        const startDate = new Date(startStr);
                        const endDate = new Date(endStr);
                        
                        // Check if dates are valid
                        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                            throw new Error('Date parsing failed');
                        }
                        
                        // Format dates properly
                        startTime = startDate.toLocaleString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        });
                        endTime = endDate.toLocaleString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        });
                        
                        console.log('Successfully parsed:', startTime, '-', endTime);
                    } catch (error) {
                        console.error('Date parsing error:', error, slot);
                        startTime = 'Parse Error';
                        endTime = 'Parse Error';
                    }
                    
                    container.append(`
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="selected-slot" value="${index}" id="slot-${index}">
                            <label class="form-check-label" for="slot-${index}">
                                ${startTime} - ${endTime}
                            </label>
                        </div>
                    `);
                });
            }

            // Back button handler
            $('#meeting-back-btn').click(function() {
                $('#schedule-step-2').hide();
                $('#schedule-step-1').show();
            });

            // Form submission handler
            $('#suggested-times-form').submit(function(e) {
                e.preventDefault();
                const selectedSlots = [];
                $('input[name="selected-slot"]:checked').each(function() {
                    selectedSlots.push($(this).val());
                });
                
                if (selectedSlots.length === 0) {
                    alert('Please select at least one time slot.');
                    return;
                }

                // Create poll with selected time slots
                const submitButton = $(this).find('button[type="submit"]');
                submitButton.prop('disabled', true).text('Creating Poll...');
                
                // Get the actual slot data from the displayed slots
                const pollSlots = [];
                selectedSlots.forEach(slotIndex => {
                    const slotData = window.currentSuggestedSlots[slotIndex];
                    if (slotData) {
                        pollSlots.push({
                            start: slotData.start,
                            end: slotData.end
                        });
                    }
                });
                
                $.ajax({
                    url: `/team/${team._id}/create_poll`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ slots: pollSlots }),
                    success: function(data) {
                        if (data.poll_id) {
                            // Show success step
                            $('#schedule-step-2').hide();
                            $('#schedule-step-3').show();
                            
                            // Refresh polls to show the new poll
                            fetchPolls();
                            
                            // Reset form after delay
                            setTimeout(() => {
                                $('#scheduleMeetingModal').modal('hide');
                                $('#schedule-step-3').hide();
                                $('#schedule-step-1').show();
                                submitButton.prop('disabled', false).text('Create Poll');
                            }, 2000);
                        } else {
                            alert('Error creating poll: ' + (data.error || 'Unknown error'));
                            submitButton.prop('disabled', false).text('Create Poll');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error creating poll:', error);
                        alert('Error creating poll. Please try again.');
                        submitButton.prop('disabled', false).text('Create Poll');
                    }
                });
            });

            // Initialize Schedule Meeting modal
            $('#scheduleMeetingModal').on('show.bs.modal', function() {
                populateParticipants();
                populateDaysOfWeek();
            });

            // Functions for meetings and polls
            function fetchMeetings() {
                $.ajax({
                    url: `/team/${team._id}/meetings`,
                    method: 'GET',
                    success: function(data) {
                        const container = $('#meetings-list');
                        if (data.meetings && data.meetings.length > 0) {
                            let html = '';
                            data.meetings.forEach(meeting => {
                                const startTime = new Date(meeting.slot.start).toLocaleString('en-US', {
                                    weekday: 'short', 
                                    month: 'short', 
                                    day: 'numeric', 
                                    hour: 'numeric', 
                                    minute: '2-digit', 
                                    hour12: true
                                });
                                const endTime = new Date(meeting.slot.end).toLocaleString('en-US', {
                                    hour: 'numeric', 
                                    minute: '2-digit', 
                                    hour12: true
                                });
                                
                                html += `
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">📅 Scheduled Meeting</h6>
                                            <p><strong>Time:</strong> ${startTime} - ${endTime}</p>
                                            <p><strong>Attendees:</strong> ${meeting.attendees.join(', ')}</p>
                                            ${meeting.poll_id_creator ? `<p class="text-muted small">Created by: ${meeting.poll_id_creator}</p>` : ''}
                                            <button class="btn btn-danger btn-sm" onclick="deleteMeeting('${meeting._id}')">
                                                Cancel Meeting
                                            </button>
                                        </div>
                                    </div>
                                `;
                            });
                            container.html(html);
                        } else {
                            container.html('<div class="empty-state">No upcoming meetings.</div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching meetings:', error);
                        $('#meetings-list').html('<div class="alert alert-danger">Error loading meetings.</div>');
                    }
                });
            }

            function fetchPolls() {
                $.ajax({
                    url: `/api/team/${team._id}/polls`,
                    method: 'GET',
                    success: function(data) {
                        const container = $('#polls-list');
                        // Store polls data globally for voting function
                        window.currentPollsData = data.polls;
                        if (data.polls && data.polls.length > 0) {
                            let html = '';
                            data.polls.forEach(poll => {
                                html += `
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">📊 Meeting Poll</h6>
                                            <p class="text-muted small">Created: ${poll.created_at ? new Date(poll.created_at).toLocaleDateString() : 'Recently'}</p>
                                            <p><strong>Participants:</strong> ${poll.participants.join(', ')}</p>
                                            <p><strong>Available Times:</strong></p>
                                            <div class="mb-2">
                                                ${poll.proposed_slots.map((slot, index) => `
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="poll-${poll._id}-slot-${index}">
                                                        <label class="form-check-label" for="poll-${poll._id}-slot-${index}">
                                                            ${new Date(slot.start).toLocaleString('en-US', {weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true})} - 
                                                            ${new Date(slot.end).toLocaleString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}
                                                        </label>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <button class="btn btn-primary btn-sm" onclick="submitPollVote('${poll._id}')">
                                                Submit Vote
                                            </button>
                                        </div>
                                    </div>
                                `;
                            });
                            container.html(html);
                        } else {
                            container.html('<div class="empty-state">No open polls.</div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching polls:', error);
                        $('#polls-list').html('<div class="alert alert-danger">Error loading polls.</div>');
                    }
                });
            }

            // Poll voting function
            function submitPollVote(pollId) {
                const selectedSlots = [];
                $(`input[id^="poll-${pollId}-slot-"]:checked`).each(function() {
                    const slotIndex = parseInt($(this).attr('id').split('-').pop());
                    // Get the actual slot data from the poll display
                    const pollCard = $(this).closest('.card');
                    const pollData = window.currentPollsData?.find(p => p._id === pollId);
                    if (pollData && pollData.proposed_slots[slotIndex]) {
                        selectedSlots.push(pollData.proposed_slots[slotIndex]);
                    }
                });
                
                if (selectedSlots.length === 0) {
                    alert('Please select at least one time slot.');
                    return;
                }
                
                $.ajax({
                    url: `/api/team/${team._id}/polls/${pollId}/vote`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 
                        user_email: user_email,
                        selected_slots: selectedSlots 
                    }),
                    success: function(data) {
                        if (data.success) {
                            alert('Vote submitted successfully!');
                            fetchPolls(); // Refresh polls
                        } else {
                            alert('Error submitting vote: ' + (data.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error submitting vote:', error);
                        alert('Error submitting vote. Please try again.');
                    }
                });
            }

            // Meeting deletion function
            function deleteMeeting(meetingId) {
                if (!confirm('Are you sure you want to cancel this meeting?')) {
                    return;
                }
                
                $.ajax({
                    url: `/api/team/${team._id}/meetings/${meetingId}`,
                    method: 'DELETE',
                    success: function(data) {
                        if (data.success) {
                            alert('Meeting cancelled successfully!');
                            fetchMeetings(); // Refresh meetings list
                        } else {
                            alert('Error cancelling meeting: ' + (data.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error cancelling meeting:', error);
                        alert('Error cancelling meeting. Please try again.');
                    }
                });
            }

            // Initialize
            fetchMeetings();
            fetchPolls();
        </script>
    </body>
</html>
